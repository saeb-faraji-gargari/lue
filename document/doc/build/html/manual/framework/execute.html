<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Execute LUE framework programs &mdash; LUE  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Scalability experiments" href="scalability.html" />
    <link rel="prev" title="C++" href="cpp/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            LUE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example/index.html">Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../data_model/index.html">data model</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">framework</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="python/index.html">Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpp/index.html">C++</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Execute LUE framework programs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#single-node-execution">Single-node execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#distributed-execution">Distributed execution</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="scalability.html">Scalability experiments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../view/index.html">view</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcraster/index.html">PCRaster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release/index.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publication/index.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../related.html">Related</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code/index.html">Code</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LUE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Manual</a></li>
          <li class="breadcrumb-item"><a href="index.html">Framework</a></li>
      <li class="breadcrumb-item active">Execute LUE framework programs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="execute-lue-framework-programs">
<span id="id1"></span><h1>Execute LUE framework programs<a class="headerlink" href="#execute-lue-framework-programs" title="Link to this heading"></a></h1>
<p>Programs that use the LUE framework can be executed on a single node,
like a laptop or desktop computer, or on a distributed memory system,
like a compute cluster.</p>
<p>LUE framework programs are designed to use the available hardware as
good as possible. Which hardware is available to the running program is
determined by command line arguments.</p>
<p>The LUE framework makes use of the HPX AMT (asynchronous many-tasks)
runtime, which can be configured using configuration files and command
line arguments. How this works is described in the
<a class="reference external" href="https://hpx-docs.stellar-group.org/latest/html/manual/launching_and_configuring_hpx_applications.html">HPX manual</a>. Additionally, LUE framework programs provide LUE-specific
command line arguments, for example for setting the partition size for
partitioned arrays.</p>
<p>The next sections provide examples for executing LUE framework
programs. Unless stated, the information is relevant for binary
programs using the <a class="reference internal" href="cpp/index.html#lue-framework-cpp-api"><span class="std std-ref">LUE framework C++ API</span></a>,
as well as for Python scripts using the <a class="reference internal" href="python/index.html#lue-framework-python-api"><span class="std std-ref">LUE framework Python API</span></a>.</p>
<p>In the examples in this section, we assume that a cluster exists with
nodes that have the following properties:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CPUs</p></td>
<td><p>2 <a class="reference external" href="https://www.amd.com/en/products/cpu/amd-epyc-7451">AMD EPYC 7451</a> (2 packages)</p></td>
</tr>
<tr class="row-odd"><td><p>NUMA nodes</p></td>
<td><p>8 (4 / package)</p></td>
</tr>
<tr class="row-even"><td><p>Cores</p></td>
<td><p>48 (6 / NUMA node)</p></td>
</tr>
</tbody>
</table>
<p>Each cluster node contains 2 CPUs, each of which contains 4 NUMA nodes,
each of which contains 6 cores. One easy way to make use of the fact
that latencies to memory within a NUMA node are smaller than between
them is to assign a LUE framework program to each NUMA node (8 /
cluster node).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case you experience crashes when running LUE framework programs, these may be related to the
custom memory allocator being loaded later than the program starts allocating memory. Memory
allocations and deallocations must be handled by the same allocation library. Depending on
how the HPX library LUE depends upon is built, a non-standard allocation library containing
faster memory allocation and deallocation functions may be used. In case of Python scripts
using LUE, this allocation library will only be loaded once the script has already started. We
have noticed that in case HPX is built with support for the tcmalloc memory allocation library,
starting LUE Python scripts like this solved the crashes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">LD_PRELOAD</span><span class="o">=</span>&lt;prefix&gt;/lib/libtcmalloc_minimal.so.4<span class="w"> </span>python<span class="w"> </span>./my_lue_script.py
</pre></div>
</div>
</div>
<section id="single-node-execution">
<h2>Single-node execution<a class="headerlink" href="#single-node-execution" title="Link to this heading"></a></h2>
<p>TODO</p>
</section>
<section id="distributed-execution">
<h2>Distributed execution<a class="headerlink" href="#distributed-execution" title="Link to this heading"></a></h2>
<section id="slurm">
<h3>SLURM<a class="headerlink" href="#slurm" title="Link to this heading"></a></h3>
<p>See also <a class="reference external" href="https://hpx-docs.stellar-group.org/latest/html/manual/running_on_batch_systems.html#how-to-use-hpx-applications-with-slurm">How to use HPX applications with SLURM</a>.</p>
<section id="synchronous">
<h4>Synchronous<a class="headerlink" href="#synchronous" title="Link to this heading"></a></h4>
<p>The example script shows how to start a synchronous SLURM job. This
is handy for quick runs, when you are still developing the model,
for example.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">UCX_LOG_LEVEL</span></code> environment variable and the <code class="docutils literal notranslate"><span class="pre">--mca</span>
<span class="pre">btl_openib_allow_ib</span> <span class="pre">true</span></code> argument of mpirun are necessary on the
cluster on which this was tested. These are unrelated to LUE or HPX,
and may or may not be necessary on other clusters.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fixed. Depends on platform.</span>
<span class="nv">partition</span><span class="o">=</span><span class="s2">&quot;my_partition&quot;</span>
<span class="nv">nr_numa_domains_per_node</span><span class="o">=</span><span class="m">8</span>
<span class="nv">nr_cores_per_socket</span><span class="o">=</span><span class="m">6</span>
<span class="nv">nr_cpus_per_task</span><span class="o">=</span><span class="m">12</span>
<span class="nv">cpu_binding</span><span class="o">=</span><span class="s2">&quot;thread:0-5=core:0-5.pu:0&quot;</span>

<span class="c1"># Depends on size of job.</span>
<span class="nv">nr_nodes</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Fixed.</span>
<span class="nv">nr_localities</span><span class="o">=</span><span class="k">$(</span>expr<span class="w"> </span><span class="nv">$nr_nodes</span><span class="w"> </span><span class="se">\*</span><span class="w"> </span><span class="nv">$nr_numa_domains_per_node</span><span class="k">)</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">UCX_LOG_LEVEL</span><span class="o">=</span>error

salloc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--partition<span class="o">=</span><span class="nv">$partition</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--nodes<span class="o">=</span><span class="nv">$nr_nodes</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ntasks<span class="o">=</span><span class="nv">$nr_localities</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cpus-per-task<span class="o">=</span><span class="nv">$nr_cpus_per_task</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cores-per-socket<span class="o">=</span><span class="nv">$nr_cores_per_socket</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>mpirun<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--mca<span class="w"> </span>btl_openib_allow_ib<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>python<span class="w"> </span>my_model.py<span class="w"> </span><span class="se">\</span>
<span class="w">            </span>my_argument1<span class="w"> </span>my_argument2<span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--hpx:ini<span class="o">=</span><span class="s2">&quot;hpx.os_threads=</span><span class="nv">$nr_cores_per_socket</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--hpx:bind<span class="o">=</span><span class="nv">$cpu_binding</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--hpx:print-bind
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case you see this warning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hpx</span><span class="p">::</span><span class="n">init</span><span class="p">:</span> <span class="n">command</span> <span class="n">line</span> <span class="n">warning</span><span class="p">:</span> <span class="o">--</span><span class="n">hpx</span><span class="p">:</span><span class="n">localities</span> <span class="n">used</span> <span class="n">when</span>
<span class="n">running</span> <span class="k">with</span> <span class="n">SLURM</span><span class="p">,</span> <span class="n">requesting</span> <span class="n">a</span> <span class="n">different</span> <span class="n">number</span> <span class="n">of</span> <span class="n">localities</span>
<span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="n">than</span> <span class="n">have</span> <span class="n">been</span> <span class="n">assigned</span> <span class="n">by</span> <span class="n">SLURM</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">the</span> <span class="n">application</span> <span class="n">might</span>
<span class="ow">not</span> <span class="n">run</span> <span class="n">properly</span><span class="o">.</span>
</pre></div>
</div>
<p>but the printed CPU bindings seem fine, then you can safely ignore it.</p>
</div>
</section>
<section id="asynchronous">
<h4>Asynchronous<a class="headerlink" href="#asynchronous" title="Link to this heading"></a></h4>
<p>The example script shows how to start an asynchronous SLURM job. This
is handy for long running runs, after you have finished developing
the model, for example.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fixed. Depends on platform.</span>
<span class="nv">partition</span><span class="o">=</span><span class="s2">&quot;my_partition&quot;</span>
<span class="nv">nr_numa_domains_per_node</span><span class="o">=</span><span class="m">8</span>
<span class="nv">nr_cores_per_socket</span><span class="o">=</span><span class="m">6</span>
<span class="nv">nr_cpus_per_task</span><span class="o">=</span><span class="m">12</span>
<span class="nv">cpu_binding</span><span class="o">=</span><span class="s2">&quot;thread:0-5=core:0-5.pu:0&quot;</span>

<span class="c1"># Depends on size of job.</span>
<span class="nv">nr_nodes</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Fixed.</span>
<span class="nv">nr_localities</span><span class="o">=</span><span class="k">$(</span>expr<span class="w"> </span><span class="nv">$nr_nodes</span><span class="w"> </span><span class="se">\*</span><span class="w"> </span><span class="nv">$nr_numa_domains_per_node</span><span class="k">)</span>

<span class="c1"># Depends on size of job</span>
<span class="nv">nr_nodes</span><span class="o">=</span><span class="m">12</span>

<span class="c1"># Fixed</span>
<span class="nv">nr_tasks</span><span class="o">=</span><span class="k">$(</span>expr<span class="w"> </span><span class="nv">$nr_nodes</span><span class="w"> </span><span class="se">\*</span><span class="w"> </span><span class="nv">$nr_numa_domains_per_node</span><span class="k">)</span>

sbatch<span class="w"> </span>--job-name<span class="w"> </span>my_job_name<span class="w"> </span><span class="s">&lt;&lt; END_OF_SLURM_SCRIPT</span>
<span class="s">#!/usr/bin/env bash</span>
<span class="s">#SBATCH --nodes=$nr_nodes</span>
<span class="s">#SBATCH --ntasks=$nr_localities</span>
<span class="s">#SBATCH --cpus-per-task=$nr_cpus_per_task</span>
<span class="s">#SBATCH --cores-per-socket=$nr_cores_per_socket</span>
<span class="s">#SBATCH --partition=$partition</span>

<span class="s">set -e</span>

<span class="s">module purge</span>
<span class="s">module load my_required_model</span>

<span class="s">mpirun \</span>
<span class="s">    --mca btl_openib_allow_ib true \</span>
<span class="s">    python my_model.py \</span>
<span class="s">        my_argument1 my_argument2 \</span>
<span class="s">        --hpx:ini=&quot;hpx.os_threads=$nr_cores_per_socket&quot; \</span>
<span class="s">        --hpx:bind=$cpu_binding \</span>
<span class="s">        --hpx:print-bind</span>

<span class="s">END_OF_SLURM_SCRIPT</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cpp/index.html" class="btn btn-neutral float-left" title="C++" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="scalability.html" class="btn btn-neutral float-right" title="Scalability experiments" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-now, LUE R&amp;D team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>